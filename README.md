<h1 id="rtl-markdown" dir="rtl">آموزش راه اندازی تونل معکوس بین 2 سرور با استفاده از SSH و Supervisor جهت اتوماسیون</h1>

این نوع تونل اصولا در شرایطی استفاده میشود که سرور مد نظر ما پشت firewall بسته و یا NAT باشد
شرایط لازم این است که سرور شما پورت های ورودی tcp آن توسط یکی از مواردی که گفته شد بسته شده باشن، اما پورت های خروجی tcp آن باز باشند.
مفهوم انجام این نوع تونل بدین شرح است که ما از طریق سرور فیلتر شده به سرور آزاد ارتباط SSH برقرار میکنیم، سپس با استفاده از همین ارتباط پایدار به صورت معکوس پورت tcp مورد نظر را از سرور آزاد به پورت tcp سرور فیلتر شده هدایت میکنیم (port forwarding)، در نتیجه کاربرات با استفاده از پورت tcp هدایت شده از سرور آزاد میتوانند به سرور فیلتر شده دسترسی داشته باشن.

تصویر مفهومی برای توضیح بهتر این نوع تونل:
<p>
سرور خارج = client
سرور ایران = gateway
هدف مورد نظر = precious resource
</p>
<img>![ssh-tunnel-remote](https://user-images.githubusercontent.com/104469759/235637820-ae1e5c76-78bc-4c4b-ab51-129c517dde34.png)</img>


<h3>1. آماده سازی سرور آزاد</h3>
فرمان زیر را در سرور آزاد اجرا کنید:

echo "GatewayPorts yes" >> /etc/ssh/sshd_config
سپس برای اعمال تغییری که تو تنظیمات sshd دادید این فرمان رو اجرا کنید:

systemctl restart sshd.service


و یادتون نره که با ابزار ufw یا هر فایروال دیگه ای مختص پنل سرویس دهنده تون، پورتای مختص سرویستون رو حتما باز کنید روی سرور ایرانی:

ufw allow 99


بعد از خروج از سرور ایرانی به یه روشی با یه فیلتر شکنی چیزی با یوزر root لاگین میکنید به سرور خارجی که فیلتره.

(هتزنر KVM Console داره با اون میرید و برای این که توش بتونید به راحتی و درستی یه دستور رو paste کنید پیشنهاد میشه از برنامه ی clickpaste استفاده کنید وگرنه paste عادی بعضی کرکترا رو بهم میریزه)

 یه کلید ssh رو سرور خارجی جنریت میکنید:

ssh-keygen -t rsa


وقتی ازتون پرسید آدرس و نیم و پسوردشو چی بزنم همه رو خالی میزارید، 2 تا فایل میسازه تو مسیر root/.ssh/ با اسمای id_rsa و id_rsa.pub که اولی کلید پرایوته و دومی پابلیک

بعد این کلیدو با یه فرمان خیلی ساده و اتوماتیک توی فایل لازم در مقصد (root/.ssh/authorized_keys/) رو سرور ایرانی کپی میکنید که به سرور ایرانی بتونید دفعه های بعدی بدون نیاز به وارد کردن پسورد با همون کلید ssh براحتی لاگین کنید (در نتیجه فعلا این یک بار رو ازتون پسورد میخواد):

ssh-copy-id -s -i ~/.ssh/id_rsa.pub root@98.98.98.98
(مجددا یادتون نره که باید ای پی سرور فرضی ایرانی آخر این فرمان 98.98.98.98 رو با ای پی سرور ایران خودتون عوض کنید !!!!)

اینجا چون بار اوله داره این سرور خارجیتون به سرور ایرانیتون ssh میزنه ازتون میپرسه که آیا این فینگرپرینت این سرور رو تراست کنم ؟ شما تایپ میکنید:

yes
رو سرور خارجی یه service/daemon manager مناسب مثل systemd یا supervisor انتخاب کنید

و اونو تنظیم کنید، آموزشاش تو اینترنت هست اما خیلی سریع supervisor رو توضیح میدم

نصب supervisor:

apt update
apt-get install supervisor -y


ساخت جاب برای برای supervisor: (میتونید نام رو با اسم دل بخواه برای خودتون جایگزین کنید، مثلا من زدم vless-reverse)

nano /etc/supervisor/conf.d/نام.conf


نمونه جابی که میزارم تو خط command رو با توجه به ای پی و پورت سرور خودتون تغییر بدید چون این مثال برا همین سناریو فرضی هست که بالا گفتم: *باید 2 بار نام که نوشتم رو با اسم دل بخواهتون عوض کنید درست مثل آی پی و پورت ها)
مجدد توجه کنید انتهای کامند به جای 98.98.98.98 باید و باید ای پی سرور ایران خودتون رو بزنید تا ssh به مقصد سرور ایران شما برقرار بشه توسط سوپروایزر

[program:نام]
command=ssh -N -R 0.0.0.0:99:localhost:99 root@98.98.98.98
directory=/root
user=root
autostart=true
autorestart=true
stdout_logfile=/var/log/supervisor/نام.log
redirect_stderr=true
numprocs=1
اینجا من کامند sshی که به کار رفته رو براتون یه توضیح میدم که هر گونه شک و شبهه رفع شه، تو این کامند با اوردن عنوان R- شما دارید نوع تانل رو Remote تایین میکنید، توجه اگه بکنید 2 قسمت هست قانون تانلی که نوشتیم
قسمت اول 0.0.0.0:99 برای اینه که تایین کنه روی سرور ایران از تمام ای پی ها (0.0.0.0 مساوی تمام ای پی هاست) روی پورت 99 هر چی درخواست ورودی اومد رو بگیر بفرست به ما
قسمت دوم localhost:99 برای سرور خارجه که خودش ssh رو زده میگه که درخواستا رو که با اون قسمت اول گرفتی بگیر بیار داخل سرور خودمون تحویل localhost پورت 99 بده (شما وقتی کانفیگ vlessی vmessی چیزی ساختی رو پورت 99، تایین کردی که رو localhost رو پورت 99 گوش بده به درخواستا) در نتیجه اینطوری تونل انجام میشه.
شما ای پی سرور ایران رو انتهای کامند بعد @root تایین میکنید میبینید که نوشتم ای پی سناریوی فرضی ایران رو
root@98.98.98.98 اینجا شما تایین میکنید ای پی ایرانتونو نه اون اول 0.0.0.0 که خیلی ها دیدم اشتباه میکنن فکر میکنن باید ای پی ایرانشونو جای 0.0.0.0 قرار بدن !
در نهایت اون N- هم که اول بعد ssh نوشتیم بابت اینه که وقتی این کامند اجرا میشه و تانل برقرار میشه بعدش نیاد شل هم بگیره، بدون هیچ شلی فقط ssh رو برقرار نگه داره.

بعد از ذخیره فایل برای بازخوانی جاب های جدید در supervisor از این فرمان استفاده کنید:

supervisorctl reread


برای راه اندازی مجدد سرویس supervisord:

supervisorctl reload
برای مشاهده وضعیت جاب های فعال در supervisor:

supervisorctl status


در نهایت جابی که تنظیم کردید اجرا میشه و میتونید روندشونو توی htop مشاهده کنید

و مهم تر این که رو سرور ایرانی باید بتونید با وارد کردن فرمان زیر:

lsof -i -P -n | grep LISTEN


تمام پورت هایی که رو این سرور (ایرانی) در حال listen شدن هستن رو مشاهده کنید

که لازمه برای موفقیت آمیز بودن تونل معکوسمون این پورت 99:* باز باشه

چیزی مشابه 2 خط زیر رو باید بتونید ببینید:

sshd   1111 root  10u IPv4 2222   0t0 TCP *:99 (LISTEN)


